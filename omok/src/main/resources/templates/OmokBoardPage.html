<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>바둑판 배경</title>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<style>
  /* 바둑판 무늬 스타일 */
    .back_board {
    	position: absolute;
    	/* top:-450px; */
    	
    	/* z-index:-1; */
    	margin: 15px;
      width: 420px; /* 바둑판의 너비 */
      height: 420px; /* 바둑판의 높이 */
      background: 
        linear-gradient(90deg, #fff 1px, transparent 1px), /* 세로 줄 */
        linear-gradient(180deg, #fff 1px, transparent 1px), /* 가로 줄 */
        #000; /* 바둑판 색상 */
      background-color: green;
      background-size: 30px 30px; /* 각 칸의 크기 */
    }
    .stone_board {
    	
		position: relative;
    	
      display: grid;
      grid-template-columns: repeat(15, 30px);
      grid-template-rows: repeat(15, 30px);
      gap: 0px;
      /* background-color: #e0e0e0; */
      /* border: 1px solid #999; */
    }
    .intersection, .placed {
      width: 30px;
      height: 30px;
      background-color: transparent;
      border-radius: 50%;
      cursor: pointer;
      border: 1px solid black;
      
    }
</style>
</head>
<body>

	<div class="back_board" id="back_board"></div>

	<div class="stone_board" id="stone_board"></div>
	
	<input type="text" placeholder="보낼 메세지를 입력하세요." class="content">
	<button type="button" value="전송" class="sendBtn" onclick="sendMsg()">전송</button>
	<div>
    	<span>메세지</span>
    <div class="msgArea"></div>
    <input id="roomID" th:value="${room.roomID}">
    <input id="userNum" th:value="${userNum}">
    <input id="stone" th:value=${stone}>
    <input id="turn" value="black">
</div>
	
	<script th:inline="javascript">
		// jquery를 이용해 id값으로 input태그의 값 가져오기
		const roomID = $("#roomID").val();
		const userNum = $("#userNum").val();
		const board = document.getElementById('stone_board');
		const ROWS = 15;
		const COLS = 15;
		const intersections = [];
		const myStone = $("#stone").val();
		
	  
		const webSocket = new WebSocket("ws://" + location.host + "/ws/omok");
		webSocket.onopen = () =>{
			/* console.log("WebSocket is open") */
			enterRoom(webSocket);
		};
	  
	  webSocket.onmessage = (e) =>{
		  
		  /* console.log(typeof e.data);
		  console.log(e.data); */
		  var transferMessage = JSON.parse(e.data);
		  
		  console.log("수신메세지 : ", transferMessage);
		  /* console.log(transferMessage.type); */
		  /* console.log(transferMessage.message); */
		  /* console.log(typeof transferMessage); */
		  
		if(transferMessage.type == "PLACE"){
			/* console.log(transferMessage.xLine); */
			/* console.log(transferMessage.yLine); */
			placeStone(transferMessage.xLine, transferMessage.yLine);
			turnOver();
		} else if(transferMessage.type == "ENTER"){
			let msgArea = document.querySelector('.msgArea');
			let newMsg = document.createElement('div');
			newMsg.innerText=transferMessage.message;
			msgArea.append(newMsg);
		}
	  };
	  
	  function sendMsg(){
		let content=document.querySelector('.content').value;
		var talkMessage={
				"type" : "TALK",
				"roomID":[[${room.roomID}]],
				"sender":[[${userNum}]],
				"message":content
				};
		webSocket.send(JSON.stringify(talkMessage));
	  }
	  
	  function enterRoom(webSocket){
		
		/* console.log(roomID); */
		/* console.log(userNum); */
		  var enterMessage = {
				  "type" : "ENTER",
				  "roomID" : roomID,
				  "sender" : userNum
		  };
		  
		  webSocket.send(JSON.stringify(enterMessage));
	  }
	  
	  // 돌 색 바꾸기
	  function placeStone(xLine, yLine){
		  var stones = document.getElementsByClassName('intersection');
		  for(var i=0;i<stones.length;i++){
			  if( Number(stones[i].dataset.col)+1 == xLine && Number(stones[i].dataset.row)+1==yLine){
				  stones[i].style.backgroundColor=$('#turn').val();
				  stones[i].setAttribute('onmouseout', "");
				  stones[i].setAttribute('id', "placed");
				  stones[i].setAttribute('class', "placed");
				  break;
			  }
		  };
		  return stones;
	  }
	  
	  /** input태그 id값이 turn인 태그의 값이 블랙이면 화이트로 값 변경<br>
	  *	값이 화이트면 블랙으로 변경<br>
	  * by woobin
	  */
	  function turnOver(){
		  var turn = $("#turn").val();
		  if(turn=="black"){
			  turnInput = document.getElementById("turn");
			  turnInput.value = "white";
		  } else if(turn=="white"){
			  turnInput = document.getElementById("turn");
			  turnInput.value = "black";
		  }
	  }
	  
	  
	
	  // 돌 생성
	  for (let i = 0; i < ROWS; i++) {
	    for (let j = 0; j < COLS; j++) {
	      const intersection = document.createElement('div');
	      intersection.classList.add('intersection');
	      intersection.id = 'intersection';
	      intersection.setAttribute('onmouseout', "this.style.backgroundColor=''")
	      intersection.dataset.row = i;
	      intersection.dataset.col = j;
	      board.appendChild(intersection);
	      intersections.push(intersection);
	    }
	  }
	
	  intersections.forEach(intersection => {
	    intersection.addEventListener('click', (e) => {
	      const clicked = e.target;
	      const row = parseInt(clicked.dataset.row);
	      const col = parseInt(clicked.dataset.col);
	      // 여기에 오목 돌을 놓는 로직을 추가할 수 있어요.
	      // 클릭된 위치에 돌을 놓는 등의 기능을 만들 수 있습니다.
	      // 예를 들어, 오목돌 이미지를 추가하거나, 돌의 상태를 기록하여 승리 여부를 확인할 수 있습니다.
	    });
	  });
	  
	  
	// JQuery
	$(document).ready(function(){
		// 돌 위에 마우스를 올렸을때 색 변경 
		$(".intersection").mouseover(function(e){
			/* console.log(e); */
			/* console.log(this); */
			/* console.log(this.dataset.col); */
			/* console.log(Number(this.dataset.col)+1); */
			/* console.log(myStone) */
			
			/* console.log(this.className); */
			// if문을 만든 이유: 처음엔 class 이름이 intersection 이었던 태그의 클래스를
			// 착수하며 placed로 바꿔서 그런지 마우스를 올리면 한번은 색이 변하는것으로 추정됨
			if(this.className == "intersection"){
				this.style.backgroundColor=myStone;
			}
		});
		
		// 돌 착수
		$(".intersection").click(function(e){
			var turn = $("#turn").val();
			var xLine = Number(this.dataset.col)+1;
			var yLine = Number(this.dataset.row)+1;
			
			
			var placeMessage={
					"type" : "PLACE",
					"roomID":[[${room.roomID}]],
					"sender":[[${userNum}]],
					"message":(Number(this.dataset.col)+1).toString()+ ","+ (Number(this.dataset.row)+1).toString(),
					"xLine":xLine,
					"yLine":yLine
					};
			/* console.log(Number(this.dataset.col)+1);
			console.log(Number(this.dataset.row)+1); */
			
			if(myStone==turn){
				
				webSocket.send(JSON.stringify(placeMessage));
			}else{
				console.log("내 턴이 아니구나!!")
			}
			
		});
	});
	
  </script>

</body>
</html>