<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>메인페이지</title>
<script src="http://code.jquery.com/jquery-latest.js"></script>
</head>
<body>
	<h1>메인 페이지</h1>
 	<h2 sec:authorize="isAuthenticated()" th:text="${User.username}"></h2> 
	<div>
          <ol class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" sec:authorize="isAnonymous()" th:href="@{/user/login}">로그인</a>
                    <a class="nav-link" sec:authorize="isAuthenticated()" th:href="@{/user/logout}">로그아웃</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/user/signup}">회원가입</a>
                </li>
           </ol>
	</div>


	<div>
		<a href="/omok/list">오목하러 가기</a>
	</div>
	<div>
		<a href="/test">테스트 페이지</a>
	</div>
		
	
	
	<h1>채팅창</h1>
	<p><textarea cols="50" rows="10" id="msgArea" readonly></textarea></p>
	
	
		<p><textarea cols="50" rows="1" id="msg"></textarea>
		<input type="submit" id="input-send" sec:authorize="isAuthenticated()" value="입력"></p>
		<!-- <input type="submit" value="입력"> -->
	

	 
	
<script th:inline="javascript">
	$(document).ready(function(){
		
		const websocket = new WebSocket("ws://localhost:8080/ws/chat");
		
	    websocket.onmessage = onMessage;
	    websocket.onopen = onOpen;
	    websocket.onclose = onClose;	
	    
	    var UserObject = [[${User}]];
	    
	    username = UserObject.nickname;
	    
	    $("#input-send").on("click", (e) => {
	    	send();
	    });
	    
	    function send(){
	    	
	    	let msg = document.getElementById("msg");
	    	
	    	console.log(username + ":" + msg.value);
	    	websocket.send(username + ":" + msg.value);
	    	msg.value = '';
	    	
	    }
	    
	    
	    // 메인페이지 접속했을 때
	    function onOpen(evt){
	    	var str = "[" + username + "] 님이 입장하셨습니다.";
	    	websocket.send(str); // handleTextMessage 호출
	    }	
		
	    
	    // 메인페이지에서 나갔을 때
	    function onClose(evt){
	    	var str = "[" + username + "] 님이 방을 나가셨습니다.";
	    	websocket.send(str);
	    }
	    
	    // 메세지 받았을 때 발생하는 이벤트
	    function onMessage(msg){
	    	console.log("msg : " + msg);
	     	var data = msg.data;
	    	var sessionId = null;
	     
	    	// 데이터를 보낸 사람
	    	var message = null;
	    	var arr = data.split(":");
	    	
	    	for(var i=0; i<arr.length; i++){
	    		console.log('arr[' + i + ']: ' + arr[i]);
	    	}
	    	
	    	var cur_session = username;
	    	
	    	// 현재 세션에 로그인 한 사람
	    	console.log("cur_session: " + cur_session);
	    	sessionId = arr[0];
	    	message = arr[1];
	    	
	    	console.log("sessionId: " + sessionId);
	    	console.log("cur_session: " + cur_session);
	    	
	    	// 로그인 한 클라이언트와 타 클라이언트를 분류하기 위함
	    	if(message!=null){
	    		var str = sessionId + " : " + message + "\n";		
	    		$("#msgArea").append(str);

	    	}
	    	else{
	    		var str = sessionId + "\n";
	    		$("#msgArea").append(str);	

	    	}
	    }		    
	})

</script>

	
</body>
</html>